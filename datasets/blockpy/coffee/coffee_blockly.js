

var coffee_INDEXES = [
    ["(None)", "(None)"],
    
    ["Data.Scores.Total", "Data.Scores.Total"] 
];

var coffee_INDEX_VALUES = {
    "(None)": [],
    
    "Data.Scores.Total": [
        
        ["0.0", "0.0"] ,
        ["59.83", "59.83"] ,
        ["63.08", "63.08"] ,
        ["67.92", "67.92"] ,
        ["68.33", "68.33"] ,
        ["69.17", "69.17"] ,
        ["69.33", "69.33"] ,
        ["70.75", "70.75"] ,
        ["71.0", "71.0"] ,
        ["71.08", "71.08"] ,
        ["71.75", "71.75"] ,
        ["72.33", "72.33"] ,
        ["72.58", "72.58"] ,
        ["72.83", "72.83"] ,
        ["72.92", "72.92"] ,
        ["73.42", "73.42"] ,
        ["73.5", "73.5"] ,
        ["73.67", "73.67"] ,
        ["73.75", "73.75"] ,
        ["73.83", "73.83"] ,
        ["74.0", "74.0"] ,
        ["74.33", "74.33"] ,
        ["74.42", "74.42"] ,
        ["74.67", "74.67"] ,
        ["74.75", "74.75"] ,
        ["74.83", "74.83"] ,
        ["74.92", "74.92"] ,
        ["75.0", "75.0"] ,
        ["75.08", "75.08"] ,
        ["75.17", "75.17"] ,
        ["75.58", "75.58"] ,
        ["75.83", "75.83"] ,
        ["76.0", "76.0"] ,
        ["76.17", "76.17"] ,
        ["76.25", "76.25"] ,
        ["76.33", "76.33"] ,
        ["76.42", "76.42"] ,
        ["76.83", "76.83"] ,
        ["77.0", "77.0"] ,
        ["77.17", "77.17"] ,
        ["77.25", "77.25"] ,
        ["77.33", "77.33"] ,
        ["77.42", "77.42"] ,
        ["77.5", "77.5"] ,
        ["77.58", "77.58"] ,
        ["77.83", "77.83"] ,
        ["77.92", "77.92"] ,
        ["78.0", "78.0"] ,
        ["78.08", "78.08"] ,
        ["78.17", "78.17"] ,
        ["78.25", "78.25"] ,
        ["78.33", "78.33"] ,
        ["78.42", "78.42"] ,
        ["78.5", "78.5"] ,
        ["78.58", "78.58"] ,
        ["78.67", "78.67"] ,
        ["78.75", "78.75"] ,
        ["78.83", "78.83"] ,
        ["78.92", "78.92"] ,
        ["79.0", "79.0"] ,
        ["79.08", "79.08"] ,
        ["79.17", "79.17"] ,
        ["79.25", "79.25"] ,
        ["79.33", "79.33"] ,
        ["79.42", "79.42"] ,
        ["79.5", "79.5"] ,
        ["79.58", "79.58"] ,
        ["79.67", "79.67"] ,
        ["79.75", "79.75"] ,
        ["79.83", "79.83"] ,
        ["79.92", "79.92"] ,
        ["80.0", "80.0"] ,
        ["80.08", "80.08"] ,
        ["80.17", "80.17"] ,
        ["80.25", "80.25"] ,
        ["80.33", "80.33"] ,
        ["80.42", "80.42"] ,
        ["80.5", "80.5"] ,
        ["80.58", "80.58"] ,
        ["80.67", "80.67"] ,
        ["80.75", "80.75"] ,
        ["80.83", "80.83"] ,
        ["80.92", "80.92"] ,
        ["81.0", "81.0"] ,
        ["81.08", "81.08"] ,
        ["81.17", "81.17"] ,
        ["81.25", "81.25"] ,
        ["81.33", "81.33"] ,
        ["81.42", "81.42"] ,
        ["81.5", "81.5"] ,
        ["81.58", "81.58"] ,
        ["81.67", "81.67"] ,
        ["81.75", "81.75"] ,
        ["81.83", "81.83"] ,
        ["81.92", "81.92"] ,
        ["82.0", "82.0"] ,
        ["82.08", "82.08"] ,
        ["82.17", "82.17"] ,
        ["82.25", "82.25"] ,
        ["82.33", "82.33"] ,
        ["82.42", "82.42"] ,
        ["82.5", "82.5"] ,
        ["82.58", "82.58"] ,
        ["82.67", "82.67"] ,
        ["82.75", "82.75"] ,
        ["82.83", "82.83"] ,
        ["82.92", "82.92"] ,
        ["83.0", "83.0"] ,
        ["83.08", "83.08"] ,
        ["83.17", "83.17"] ,
        ["83.25", "83.25"] ,
        ["83.33", "83.33"] ,
        ["83.42", "83.42"] ,
        ["83.5", "83.5"] ,
        ["83.58", "83.58"] ,
        ["83.67", "83.67"] ,
        ["83.75", "83.75"] ,
        ["83.83", "83.83"] ,
        ["83.92", "83.92"] ,
        ["84.0", "84.0"] ,
        ["84.08", "84.08"] ,
        ["84.13", "84.13"] ,
        ["84.17", "84.17"] ,
        ["84.25", "84.25"] ,
        ["84.33", "84.33"] ,
        ["84.42", "84.42"] ,
        ["84.5", "84.5"] ,
        ["84.58", "84.58"] ,
        ["84.67", "84.67"] ,
        ["84.75", "84.75"] ,
        ["84.83", "84.83"] ,
        ["84.92", "84.92"] ,
        ["85.0", "85.0"] ,
        ["85.08", "85.08"] ,
        ["85.17", "85.17"] ,
        ["85.25", "85.25"] ,
        ["85.33", "85.33"] ,
        ["85.42", "85.42"] ,
        ["85.5", "85.5"] ,
        ["85.58", "85.58"] ,
        ["85.75", "85.75"] ,
        ["85.83", "85.83"] ,
        ["85.92", "85.92"] ,
        ["86.0", "86.0"] ,
        ["86.08", "86.08"] ,
        ["86.17", "86.17"] ,
        ["86.25", "86.25"] ,
        ["86.42", "86.42"] ,
        ["86.5", "86.5"] ,
        ["86.67", "86.67"] ,
        ["86.83", "86.83"] ,
        ["86.92", "86.92"] ,
        ["87.08", "87.08"] ,
        ["87.17", "87.17"] ,
        ["87.25", "87.25"] ,
        ["87.58", "87.58"] ,
        ["87.92", "87.92"] ,
        ["88.08", "88.08"] ,
        ["88.25", "88.25"] ,
        ["88.75", "88.75"] ,
        ["88.83", "88.83"] ,
        ["89.0", "89.0"] ,
        ["89.92", "89.92"] ,
        ["90.58", "90.58"] 
    ]
}

var coffee_PROPERTIES = [
    ["Location.Country", "Location.Country"] ,
    ["Location.Region", "Location.Region"] ,
    ["Location.Altitude.Min", "Location.Altitude.Min"] ,
    ["Location.Altitude.Max", "Location.Altitude.Max"] ,
    ["Location.Altitude.Average", "Location.Altitude.Average"] ,
    ["Year", "Year"] ,
    ["Data.Owner", "Data.Owner"] ,
    ["Data.Type.Species", "Data.Type.Species"] ,
    ["Data.Type.Variety", "Data.Type.Variety"] ,
    ["Data.Type.Processing method", "Data.Type.Processing method"] ,
    ["Data.Production.Number of bags", "Data.Production.Number of bags"] ,
    ["Data.Production.Bag weight", "Data.Production.Bag weight"] ,
    ["Data.Scores.Aroma", "Data.Scores.Aroma"] ,
    ["Data.Scores.Flavor", "Data.Scores.Flavor"] ,
    ["Data.Scores.Aftertaste", "Data.Scores.Aftertaste"] ,
    ["Data.Scores.Acidity", "Data.Scores.Acidity"] ,
    ["Data.Scores.Body", "Data.Scores.Body"] ,
    ["Data.Scores.Balance", "Data.Scores.Balance"] ,
    ["Data.Scores.Uniformity", "Data.Scores.Uniformity"] ,
    ["Data.Scores.Sweetness", "Data.Scores.Sweetness"] ,
    ["Data.Scores.Moisture", "Data.Scores.Moisture"] ,
    ["Data.Scores.Total", "Data.Scores.Total"] ,
    ["Data.Color", "Data.Color"] 
]

Blockly.Blocks['coffee_get'] = {
  init: function() {
    this.setColour(45);
    this.appendDummyInput('MAIN')
        .appendField("coffee.get")
        .appendField(new Blockly.FieldDropdown(coffee_PROPERTIES), "PROPERTY");
    this.appendDummyInput('SECOND')
        .appendField("filter")
        .appendField(new Blockly.FieldDropdown(coffee_INDEXES, function(option) {
                        this.getSourceBlock().updateShape_(option);
                    }), "INDEX")
    this.updateShape_("(None)");
    this.setInputsInline(false);
    this.setOutput(true, "Array");
    this.setTooltip('Returns a list of coffee data.');
  },
  mutationToDom: function() {
    var container = document.createElement('mutation');
    container.setAttribute('index', this.getFieldValue('INDEX'));
    container.setAttribute('index_value', this.getFieldValue('INDEX_VALUE'));
    container.setAttribute('module', "coffee")
    return container;
  },
  domToMutation: function(xmlElement) {
    var index = xmlElement.getAttribute('index');
    this.setFieldValue(index, 'INDEX');
    var index_value = xmlElement.getAttribute('index_value');
    this.updateShape_(index, index_value);
  },
  updateShape_: function(index, index_value) {
    var inputGroup = this.getInput('SECOND')
    var fieldExists = this.getField('INDEX_VALUE');
    if (fieldExists) {
        inputGroup.removeField('INDEX_VALUE');
    }
    try {
        if (index != undefined && index != '(None)') {
            inputGroup.appendField(new Blockly.FieldDropdown(coffee_INDEX_VALUES[index]), 'INDEX_VALUE')
            if (index_value != undefined) {
                this.setFieldValue(index_value, 'INDEX_VALUE');
            } else {
                this.setFieldValue(coffee_INDEX_VALUES[index][0][0], 'INDEX_VALUE');
            }
        }
    } catch (e) {
        inputGroup.appendField(new Blockly.FieldLabel("Reset to fix the blocks"));
        console.error(e);
    }
  }
};
Blockly.Python['coffee_get'] = function(block) {
    Blockly.Python.definitions_['import_coffee'] = 'import coffee';
    var propertyValue = block.getFieldValue('PROPERTY') || '';
    var property = Blockly.Python.quote_(propertyValue);
    var index_unquoted = block.getFieldValue('INDEX');
    var index = Blockly.Python.quote_(index_unquoted || '');
    var index_value = "''";
    if (index_unquoted !== '(None)') {
        var iv = block.getFieldValue('INDEX_VALUE') || "";
        index_value = Blockly.Python.quote_(iv);
    }
    var code = 'coffee.get('+property+',' +index+','+index_value+')';
    return [code, Blockly.Python.ORDER_ATOMIC];
};

BlockMirrorTextToBlocks.prototype.MODULE_FUNCTION_SIGNATURES['coffee'] = {
    "get": {
        custom: function(node, parent) {
            if (!node.args || node.args.length < 3 ||
                !node.args[0] || !node.args[1] || !node.args[2] ||
                node.args[0]._astname !== "Str" || node.args[1]._astname !== "Str" || node.args[2]._astname !== "Str"
            ) {
                throw new Error("Not the right function call.");
            }
            return BlockMirrorTextToBlocks.create_block("coffee_get", null,
                {"PROPERTY": node.args[0].s.v},
                {}, {}, {"@INDEX": node.args[1].s.v,
                    "@INDEX_VALUE": node.args[2].s.v});
        }
    },
};

BlockMirrorBlockEditor.EXTRA_TOOLS['Data - coffee'] = '<category name="Data - Coffee" colour="45">'+
                    '<block type="coffee_get"><mutation index="(None)" index_value=""></mutation></block>'+
                '</category>';